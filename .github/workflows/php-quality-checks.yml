name: ðŸ˜ PHP Quality Checks

on:
  workflow_call:
    secrets:
      composer-auth:
        description: "JSON string for Composer authentication (e.g., for private repositories)"
        required: false
    inputs:
      # PHP Configuration
      php-version:
        description: "PHP version to use (8.1, 8.2, 8.3)"
        type: string
        required: true

      php-extensions:
        description: "PHP Extensions to use redis, exif, etc"
        type: string
        required: false
        default: "bcmath bz2 calendar exif gd gettext intl mysqli opcache pdo_mysql redis soap sockets sodium sysvmsg sysvsem sysvshm xsl zip pcntl"

      # PHPStan Configuration
      phpstan-level:
        description: "PHPStan analysis level (1-9)"
        type: string
        required: false
        default: "6"
      skip-phpstan:
        description: "Skip PHPStan static analysis"
        type: boolean
        required: false
        default: false

      # PHP CodeSniffer Configuration
      coding-standard:
        description: "Coding standard to use (Magento2, PSR12, PSR2)"
        type: string
        required: false
        default: "Magento2"
      skip-phpcs:
        description: "Skip PHP CodeSniffer checks"
        type: boolean
        required: false
        default: false

      # Testing Configuration
      coverage-threshold:
        description: "Code coverage threshold percentage (0-100)"
        type: string
        required: false
        default: "80"
      skip-tests:
        description: "Skip PHP unit testing"
        type: boolean
        required: false
        default: false

      # Composer Configuration
      composer-args:
        description: "Additional composer install arguments"
        type: string
        required: false
        default: ""

      # System Configuration
      memory-limit:
        description: "PHP memory limit for analysis tools"
        type: string
        required: false
        default: "512M"

      # Debug Configuration
      debug:
        description: "Enable verbose logging and debug output"
        type: boolean
        required: false
        default: false

jobs:
  # Validate configuration and detect available tools
  prepare:
    name: ðŸ” Prepare PHP Analysis
    runs-on: ubuntu-latest
    outputs:
      has-composer: ${{ steps.check-files.outputs.has-composer }}
      has-phpunit: ${{ steps.check-tools.outputs.has-phpunit }}
      has-phpstan-config: ${{ steps.check-tools.outputs.has-phpstan-config }}
      has-phpcs-config: ${{ steps.check-tools.outputs.has-phpcs-config }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for required files
        id: check-files
        run: |
          if [ -f "composer.json" ]; then
            echo "âœ… composer.json found"
            echo "has-composer=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ composer.json not found"
            echo "has-composer=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for analysis tool configurations
        id: check-tools
        run: |
          # Check for PHPUnit
          if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ] || [ -f "phpunit.dist.xml" ]; then
            echo "âœ… PHPUnit configuration found"
            echo "has-phpunit=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No PHPUnit configuration found"
            echo "has-phpunit=false" >> $GITHUB_OUTPUT
          fi

          # Check for PHPStan
          if [ -f "phpstan.neon" ] || [ -f "phpstan.neon.dist" ] || [ -f "phpstan.dist.neon" ]; then
            echo "âœ… PHPStan configuration found"
            echo "has-phpstan-config=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No PHPStan configuration found, will use defaults"
            echo "has-phpstan-config=false" >> $GITHUB_OUTPUT
          fi

          # Check for PHPCS
          if [ -f "phpcs.xml" ] || [ -f "phpcs.xml.dist" ] || [ -f "phpcs.dist.xml" ] || [ -f ".phpcs.xml" ]; then
            echo "âœ… PHPCS configuration found"
            echo "has-phpcs-config=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No PHPCS configuration found, will use standard"
            echo "has-phpcs-config=false" >> $GITHUB_OUTPUT
          fi


  # Install Composer dependencies with caching
  install:
    name: ðŸ“¦ Install Dependencies
    needs: prepare
    if: needs.prepare.outputs.has-composer == 'true'
    runs-on: ubuntu-latest
    env:
      COMPOSER_AUTH: ${{ secrets.composer-auth }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.php-extensions }}
          coverage: none
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Validate composer.json and composer.lock
        run: composer validate ${{ inputs.debug && '--verbose' || '' }}

      - name: Install Composer Dependencies
        run: |
          composer install \
            --no-progress \
            --no-suggest \
            --no-interaction \
            --optimize-autoloader \
            --classmap-authoritative \
            ${{ inputs.composer-args }} \
            ${{ inputs.debug && '--verbose' || '' }}

      # Archive vendor directory for other jobs
      - name: Archive vendor directory
        run: tar -czf vendor.tar.gz vendor/

      - uses: actions/upload-artifact@v4
        with:
          name: vendor-php${{ inputs.php-version }}
          path: vendor.tar.gz
          retention-days: 1

  # PHPStan static analysis
  phpstan:
    name: ðŸ” PHPStan Analysis
    needs: [prepare, install]
    if: |
      inputs.skip-phpstan == false &&
      needs.prepare.outputs.has-composer == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.php-extensions }}
          coverage: none
          tools: composer:v2

      - uses: actions/download-artifact@v4
        with:
          name: vendor-php${{ inputs.php-version }}

      - name: Extract vendor directory
        run: tar -xzf vendor.tar.gz

      - name: Cache PHPStan results
        uses: actions/cache@v4
        with:
          path: /tmp/phpstan
          key: phpstan-php${{ inputs.php-version }}-${{ inputs.phpstan-level }}-${{ hashFiles('**/*.php') }}
          restore-keys: |
            phpstan-php${{ inputs.php-version }}-${{ inputs.phpstan-level }}-
            phpstan-php${{ inputs.php-version }}-

      - name: Run PHPStan analysis
        run: |
          echo "ðŸ” Running PHPStan analysis (Level ${{ inputs.phpstan-level }})..."

          # Check for custom phpstan script first
          if composer run-script --list | grep -q "phpstan"; then
            echo "âœ… Using composer phpstan script"
            composer run-script phpstan
          elif [ -f "phpstan.sh" ]; then
            echo "âœ… Using phpstan.sh script"
            chmod +x phpstan.sh
            ./phpstan.sh
          elif [ -f "vendor/bin/phpstan" ]; then
            echo "âœ… Using vendor PHPStan"
            phpstan_cmd="vendor/bin/phpstan"

            # Build PHPStan command
            cmd="php -d memory_limit=${{ inputs.memory-limit }} $phpstan_cmd analyse"

            # Use existing config or set defaults
            if [ "${{ needs.prepare.outputs.has-phpstan-config }}" = "true" ]; then
              echo "âœ… Using existing PHPStan configuration"
            else
              echo "â„¹ï¸ Using default PHPStan configuration"
              cmd="$cmd --level=${{ inputs.phpstan-level }} src/ app/"
            fi

            # Add debug flags if enabled
            if [ "${{ inputs.debug }}" = "true" ]; then
              cmd="$cmd --verbose --debug"
            fi

            # Execute PHPStan
            eval $cmd
          else
            echo "Installing PHPStan globally..."
            composer global require phpstan/phpstan:^1.0
            phpstan_cmd="phpstan"

            # Build PHPStan command
            cmd="php -d memory_limit=${{ inputs.memory-limit }} $phpstan_cmd analyse"
            cmd="$cmd --level=${{ inputs.phpstan-level }} src/ app/"

            # Add debug flags if enabled
            if [ "${{ inputs.debug }}" = "true" ]; then
              cmd="$cmd --verbose --debug"
            fi

            # Execute PHPStan
            eval $cmd
          fi

  # PHP CodeSniffer style checks
  phpcs:
    name: ðŸŽ¨ Code Style Check
    needs: [prepare, install]
    if: |
      inputs.skip-phpcs == false &&
      needs.prepare.outputs.has-composer == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.php-extensions }}
          coverage: none
          tools: composer:v2

      - uses: actions/download-artifact@v4
        with:
          name: vendor-php${{ inputs.php-version }}

      - name: Extract vendor directory
        run: tar -xzf vendor.tar.gz

      - name: Run PHP CodeSniffer
        run: |
          echo "ðŸŽ¨ Running PHP CodeSniffer (${{ inputs.coding-standard }} standard)..."

          # Check for custom check-style script first
          if composer run-script --list | grep -q "check-style"; then
            echo "âœ… Using composer check-style script"
            composer run-script check-style
          elif [ "${{ needs.prepare.outputs.has-phpcs-config }}" = "true" ]; then
            echo "âœ… Using existing PHPCS configuration"
            if [ -f "vendor/bin/phpcs" ]; then
              phpcs_cmd="vendor/bin/phpcs"
            else
              echo "Installing PHP CodeSniffer globally..."
              composer global require squizlabs/php_codesniffer:^3.0
              phpcs_cmd="phpcs"
            fi

            cmd="php -d memory_limit=${{ inputs.memory-limit }} $phpcs_cmd --report=full --colors"
            if [ "${{ inputs.debug }}" = "true" ]; then
              cmd="$cmd --verbose"
            fi
            eval $cmd
          elif [ -f "vendor/bin/phpcs" ]; then
            echo "âœ… Using vendor PHPCS with ${{ inputs.coding-standard }} standard"
            phpcs_cmd="vendor/bin/phpcs"

            # Build PHPCS command
            cmd="php -d memory_limit=${{ inputs.memory-limit }} $phpcs_cmd"
            cmd="$cmd --standard=${{ inputs.coding-standard }} src/ app/"
            cmd="$cmd --report=full --colors"

            if [ "${{ inputs.debug }}" = "true" ]; then
              cmd="$cmd --verbose"
            fi

            eval $cmd
          else
            echo "Installing PHP CodeSniffer globally..."
            composer global require squizlabs/php_codesniffer:^3.0
            phpcs_cmd="phpcs"

            # Install Magento2 standard if needed
            if [ "${{ inputs.coding-standard }}" = "Magento2" ]; then
              composer global require magento/magento-coding-standard:*
            fi

            # Build PHPCS command
            cmd="php -d memory_limit=${{ inputs.memory-limit }} $phpcs_cmd"
            cmd="$cmd --standard=${{ inputs.coding-standard }} src/ app/"
            cmd="$cmd --report=full --colors"

            if [ "${{ inputs.debug }}" = "true" ]; then
              cmd="$cmd --verbose"
            fi

            eval $cmd
          fi

  # PHPUnit testing with coverage
  test:
    name: ðŸ§ª Unit Tests
    needs: [prepare, install]
    if: |
      inputs.skip-tests == false &&
      needs.prepare.outputs.has-composer == 'true' &&
      needs.prepare.outputs.has-phpunit == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP with Xdebug
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.php-extensions }}, xdebug
          coverage: xdebug
          tools: composer:v2

      - uses: actions/download-artifact@v4
        with:
          name: vendor-php${{ inputs.php-version }}

      - name: Extract vendor directory
        run: tar -xzf vendor.tar.gz

      - name: Run PHPUnit tests
        run: |
          echo "ðŸ§ª Running PHPUnit tests with coverage..."

          # Check if PHPUnit is installed
          if [ -f "vendor/bin/phpunit" ]; then
            phpunit_cmd="vendor/bin/phpunit"
          else
            echo "âŒ PHPUnit not found in vendor/bin/"
            exit 1
          fi

          # Build PHPUnit command with coverage
          cmd="php -d memory_limit=${{ inputs.memory-limit }} -d xdebug.mode=coverage $phpunit_cmd"
          cmd="$cmd --coverage-text --coverage-clover=coverage.xml"

          # Add debug flags if enabled
          if [ "${{ inputs.debug }}" = "true" ]; then
            cmd="$cmd --verbose"
          fi

          # Execute PHPUnit
          eval $cmd

      - name: Check coverage threshold
        run: |
          threshold=${{ inputs.coverage-threshold }}
          if [ -f "coverage.xml" ] && [ "$threshold" != "0" ]; then
            echo "ðŸ“Š Checking coverage threshold ($threshold%)..."

            # Extract coverage percentage from clover XML
            coverage=$(php -r "
              \$xml = simplexml_load_file('coverage.xml');
              \$metrics = \$xml->project->metrics;
              \$covered = (float)\$metrics['coveredstatements'];
              \$total = (float)\$metrics['statements'];
              \$percentage = \$total > 0 ? (\$covered / \$total) * 100 : 0;
              echo round(\$percentage, 2);
            ")

            echo "ðŸ“Š Current coverage: $coverage%"

            # Compare with threshold
            if (( $(echo "$coverage < $threshold" | bc -l) )); then
              echo "âŒ Coverage $coverage% is below threshold $threshold%"
              exit 1
            else
              echo "âœ… Coverage $coverage% meets threshold $threshold%"
            fi
          else
            echo "â„¹ï¸ Skipping coverage threshold check"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-php${{ inputs.php-version }}
          path: coverage.xml
          retention-days: 7


  # Cleanup artifacts
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [install, phpstan, phpcs, test]
    if: always()
    permissions:
      actions: write
    steps:
      - name: Delete temporary artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.GITHUB_RUN_ID,
            });

            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('vendor-php')) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                core.info(`ðŸ—‘ï¸ Deleted artifact '${artifact.name}'`);
              }
            }
