name: ‚òÅÔ∏è AWS CDK Deployment

on:
  workflow_call:
    inputs:
      # Core Configuration
      aws-region:
        description: "AWS region for deployment"
        type: string
        required: false
        default: "ap-southeast-2"
      cdk-stack-name:
        description: "CDK stack name to deploy (required)"
        type: string
        required: true
      environment-target:
        description: "Target environment (staging/production/development)"
        type: string
        required: false
        default: "development"
      aws-access-key-id:
        description: "AWS access key ID"
        type: string
        required: true
      
      # Deployment Control
      bootstrap-stack:
        description: "Bootstrap CDK environment before deployment"
        type: boolean
        required: false
        default: false
      deploy:
        description: "Boolean for CDK deploy"
        type: boolean
        required: false
        default: false
      diff:
        description: "Boolean for CDK diff"
        type: boolean
        required: false
        default: false
      synth:
        description: "Boolean for CDK synth"
        type: boolean
        required: false
        default: false
      
      # Advanced Configuration
      context-values:
        description: "CDK context values as JSON object"
        type: string
        required: false
        default: "{}"
      extra-arguments:
        description: "Extra arguments"
        type: string
        required: false
      debug:
        description: "Enable verbose logging and debug output"
        type: boolean
        required: false
        default: false

    secrets:
      aws-secret-access-key:
        description: "AWS secret access key"
        required: true
      cfn-execution-role:
        description: "CloudFormation execution role ARN (optional, for cross-account deployments)"
        required: false

    outputs:
      stack-outputs:
        description: "CloudFormation stack outputs as JSON"
        value: ${{ jobs.deploy.outputs.stack-outputs }}
      deployment-status:
        description: "Deployment status (success/failed)"
        value: ${{ jobs.deploy.outputs.deployment-status }}

jobs:
  # Setup Node.js environment with caching
  setup-node:
    name: üöÄ Setup Node.js Environment
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.node-version.outputs.version }}
      package-manager: ${{ steps.detect-package-manager.outputs.manager }}
      cache-key: ${{ steps.cache-config.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Node.js version
        id: node-version
        run: |
          if [ -f ".nvmrc" ]; then
            NODE_VERSION=$(cat .nvmrc | tr -d '\n' | tr -d 'v')
            echo "version=$NODE_VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Using Node.js version from .nvmrc: $NODE_VERSION"
          else
            echo "‚ùå Error: No .nvmrc file found. Please create an .nvmrc file with the required Node.js version."
            exit 1
          fi

      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "yarn.lock" ]; then
            if [ -f ".yarnrc.yml" ] || [ -f ".yarnrc" ]; then
              echo "manager=yarn-berry" >> $GITHUB_OUTPUT
              echo "‚úÖ Detected Yarn Berry (v2+)"
            else
              echo "manager=yarn-classic" >> $GITHUB_OUTPUT
              echo "‚úÖ Detected Yarn Classic (v1)"
            fi
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected pnpm"
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected npm"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node-version.outputs.version }}

      - name: Configure cache key
        id: cache-config
        run: |
          CACHE_KEY="node-${{ steps.node-version.outputs.version }}-${{ steps.detect-package-manager.outputs.manager }}-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT

  # Validate inputs and prepare deployment configuration
  prepare:
    name: üîç Prepare CDK Deployment
    runs-on: ubuntu-latest
    outputs:
      context-args: ${{ steps.context-config.outputs.args }}
      sanitised-cdk-stack-name: ${{ steps.sanitise.outputs.sanitised-cdk-stack-name }}
    steps:
      - name: Validate required inputs
        run: |
          echo "üîç Validating deployment configuration..."
          
          if [ -z "${{ inputs.cdk-stack-name }}" ]; then
            echo "‚ùå Error: cdk-stack-name is required"
            exit 1
          fi
          
          # Validate environment target
          case "${{ inputs.environment-target }}" in
            staging|production|development)
              echo "‚úÖ Environment target: ${{ inputs.environment-target }}"
              ;;
            *)
              echo "‚ùå Error: environment-target must be one of: staging, production, development"
              exit 1
              ;;
          esac
          
          # Validate context JSON if provided
          if [ "${{ inputs.context-values }}" != "{}" ]; then
            echo '${{ inputs.context-values }}' | jq . > /dev/null
            if [ $? -ne 0 ]; then
              echo "‚ùå Error: context-values must be valid JSON"
              exit 1
            fi
          fi

          # Validate that at least one of synth, diff or deploy is true
          if [ "${{ inputs.synth }}" != "true" ] && [ "${{ inputs.diff }}" != "true" ] && [ "${{ inputs.deploy }}" != "true" ]; then
            echo "‚ùå Error: At least one of synth, diff, or deploy must be true"
            exit 1
          fi
          
          echo "‚úÖ All inputs validated successfully"

      - name: Configure CDK context
        id: context-config
        run: |
          echo "‚öôÔ∏è Configuring CDK context..."

          context_args=""

          # Add environment-specific context
          context_args="$context_args --context environment=${{ inputs.environment-target }}"

          # Add custom context values (using process substitution to avoid subshell)
          if [ "${{ inputs.context-values }}" != "{}" ]; then
            while read -r ctx; do
              context_args="$context_args $ctx"
            done < <(echo '${{ inputs.context-values }}' | jq -r 'to_entries[] | "--context \(.key)=\(.value)"')
          fi

          echo "args=$context_args" >> $GITHUB_OUTPUT
          echo "‚úÖ Context arguments configured"

      - name: Sanitise stack name
        id: sanitise
        run: |
          sanitised_cdk_stack_name=$(echo "${{ inputs.cdk-stack-name }}" | tr -cd '[:alnum:]-_')
          echo "sanitised-cdk-stack-name=$sanitised_cdk_stack_name" >> $GITHUB_OUTPUT

  # Bootstrap CDK environment if required
  bootstrap:
    name: ü•æ CDK Bootstrap
    runs-on: ubuntu-latest
    needs: [setup-node, prepare]
    if: inputs.bootstrap-stack == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}

      - name: Enable Corepack
        if: needs.setup-node.outputs.package-manager == 'yarn-berry'
        run: |
          echo "üîß Enabling Corepack for Yarn Berry..."
          corepack enable
          echo "‚úÖ Corepack enabled"

      - name: Configure dependency cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}
          cache: ${{ needs.setup-node.outputs.package-manager == 'yarn-berry' && 'yarn' || (needs.setup-node.outputs.package-manager == 'yarn-classic' && 'yarn' || needs.setup-node.outputs.package-manager) }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ inputs.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ secrets.cfn-execution-role }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with ${{ needs.setup-node.outputs.package-manager }}..."

          verbose=""
          if [ "${{ inputs.debug }}" = "true" ]; then
            verbose="--verbose"
          fi

          case "${{ needs.setup-node.outputs.package-manager }}" in
            "npm")
              npm ci $verbose
              ;;
            "yarn-classic")
              yarn install --frozen-lockfile $verbose
              ;;
            "yarn-berry")
              yarn install --immutable $verbose
              ;;
            "pnpm")
              pnpm install --frozen-lockfile $verbose
              ;;
          esac

      - name: Bootstrap CDK environment
        run: |
          echo "ü•æ Bootstrapping CDK environment..."
          
          verbose=""
          if [ "${{ inputs.debug }}" = "true" ]; then
            verbose="--verbose"
          fi
          
          role_args=""
          if [ -n "${{ secrets.cfn-execution-role }}" ]; then
            role_args="--cloudformation-execution-policies ${{ secrets.cfn-execution-role }}"
          fi
          
          npx cdk bootstrap \
            aws://$(aws sts get-caller-identity --query Account --output text)/${{ inputs.aws-region }} \
            $role_args \
            $verbose
          
          echo "‚úÖ CDK environment bootstrapped successfully"

  # Synthesize CDK application
  synth:
    name: üî® CDK Synthesis
    runs-on: ubuntu-latest
    needs: [setup-node, prepare, bootstrap]
    if: |
      !cancelled() &&
      needs.setup-node.result == 'success' &&
      needs.prepare.result == 'success' &&
      (needs.bootstrap.result == 'success' || needs.bootstrap.result == 'skipped') &&
      inputs.synth == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}

      - name: Enable Corepack
        if: needs.setup-node.outputs.package-manager == 'yarn-berry'
        run: |
          echo "üîß Enabling Corepack for Yarn Berry..."
          corepack enable
          echo "‚úÖ Corepack enabled"

      - name: Configure dependency cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}
          cache: ${{ needs.setup-node.outputs.package-manager == 'yarn-berry' && 'yarn' || (needs.setup-node.outputs.package-manager == 'yarn-classic' && 'yarn' || needs.setup-node.outputs.package-manager) }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ inputs.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ secrets.cfn-execution-role }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with ${{ needs.setup-node.outputs.package-manager }}..."

          verbose=""
          if [ "${{ inputs.debug }}" = "true" ]; then
            verbose="--verbose"
          fi

          case "${{ needs.setup-node.outputs.package-manager }}" in
            "npm")
              npm ci $verbose
              ;;
            "yarn-classic")
              yarn install --frozen-lockfile $verbose
              ;;
            "yarn-berry")
              yarn install --immutable $verbose
              ;;
            "pnpm")
              pnpm install --frozen-lockfile $verbose
              ;;
          esac

      - name: Synthesize CDK application
        run: |
          echo "üî® Synthesizing CDK application..."
          
          verbose=""
          if [ "${{ inputs.debug }}" = "true" ]; then
            verbose="--verbose"
          fi
          
          npx cdk synth ${{ inputs.cdk-stack-name }} \
            ${{ needs.prepare.outputs.context-args }} \
            ${{ inputs.extra-arguments }}  \
            $verbose
          
          echo "‚úÖ CDK synthesis completed successfully"

      - name: Upload synthesis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cdk-synthesis-${{ needs.prepare.outputs.sanitised-cdk-stack-name }}
          path: cdk.out/
          retention-days: 30

  # Generate deployment diff
  diff:
    name: üìä CDK Diff
    runs-on: ubuntu-latest
    needs: [setup-node, prepare, synth]
    if: |
      !cancelled() &&
      needs.setup-node.result == 'success' &&
      needs.prepare.result == 'success' &&
      (needs.synth.result == 'success' || needs.synth.result == 'skipped') &&
      inputs.diff == true
    outputs:
      has-changes: ${{ steps.diff-analysis.outputs.has-changes }}
      diff-summary: ${{ steps.diff-analysis.outputs.summary }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}

      - name: Enable Corepack
        if: needs.setup-node.outputs.package-manager == 'yarn-berry'
        run: |
          echo "üîß Enabling Corepack for Yarn Berry..."
          corepack enable
          echo "‚úÖ Corepack enabled"

      - name: Configure dependency cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}
          cache: ${{ needs.setup-node.outputs.package-manager == 'yarn-berry' && 'yarn' || (needs.setup-node.outputs.package-manager == 'yarn-classic' && 'yarn' || needs.setup-node.outputs.package-manager) }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ inputs.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ secrets.cfn-execution-role }}

      - name: Download synthesis artifacts
        if: needs.synth.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cdk-synthesis-${{ needs.prepare.outputs.sanitised-cdk-stack-name }}
          path: cdk.out/

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with ${{ needs.setup-node.outputs.package-manager }}..."

          case "${{ needs.setup-node.outputs.package-manager }}" in
            "npm")
              npm ci
              ;;
            "yarn-classic")
              yarn install --frozen-lockfile
              ;;
            "yarn-berry")
              yarn install --immutable
              ;;
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
          esac

      - name: Generate deployment diff
        id: diff-analysis
        run: |
          echo "üìä Analyzing deployment changes..."
          
          # Generate diff output
          diff_output=$(npx cdk diff ${{ inputs.cdk-stack-name }} \
            ${{ needs.prepare.outputs.context-args }} \
            ${{ inputs.extra-arguments }}  \
            --no-color 2>&1 || true)
          
          # Save diff to file for analysis
          echo "$diff_output" > deployment-diff.txt
          
          # Analyze diff for changes
          if echo "$diff_output" | grep -q "There were no differences"; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "summary=No infrastructure changes detected" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected in infrastructure"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            # Create summary
            summary="Infrastructure changes detected"
            if echo "$diff_output" | grep -q "Resources"; then
              summary="$summary - Resource modifications found"
            fi
            
            echo "summary=$summary" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Infrastructure changes detected!"
            echo "$diff_output"
          fi

      - name: Upload diff analysis
        uses: actions/upload-artifact@v4
        with:
          name: deployment-diff-${{ needs.prepare.outputs.sanitised-cdk-stack-name }}
          path: deployment-diff.txt
          retention-days: 30

  # Deploy CDK stack
  deploy:
    name: 'üöÄ CDK Deploy'
    runs-on: ubuntu-latest
    needs: [setup-node, prepare, synth, diff]
    if: |
      !cancelled() &&
      needs.setup-node.result == 'success' &&
      needs.prepare.result == 'success' &&
      (needs.synth.result == 'success' || needs.synth.result == 'skipped') &&
      (needs.diff.result == 'success' || needs.diff.result == 'skipped') &&
      inputs.deploy == true
    environment: ${{ inputs.environment-target }}
    outputs:
      stack-outputs: ${{ steps.deployment.outputs.stack-outputs }}
      deployment-status: ${{ steps.deployment.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}
          cache: ${{ needs.setup-node.outputs.package-manager == 'yarn-berry' && 'yarn' || (needs.setup-node.outputs.package-manager == 'yarn-classic' && 'yarn' || needs.setup-node.outputs.package-manager) }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ inputs.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ secrets.cfn-execution-role }}

      - name: Download synthesis artifacts
        if: needs.synth.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: cdk-synthesis-${{ needs.prepare.outputs.sanitised-cdk-stack-name }}
          path: cdk.out/

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with ${{ needs.setup-node.outputs.package-manager }}..."

          case "${{ needs.setup-node.outputs.package-manager }}" in
            "npm")
              npm ci
              ;;
            "yarn-classic")
              yarn install --frozen-lockfile
              ;;
            "yarn-berry")
              yarn install --immutable
              ;;
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
          esac

      - name: Execute CDK deployment
        id: deployment
        run: |
          verbose=""
          if [ "${{ inputs.debug }}" = "true" ]; then
            verbose="--verbose"
          fi
          
          echo "üöÄ Deploying CDK stack: ${{ inputs.cdk-stack-name }}"
          
          npx cdk deploy ${{ inputs.cdk-stack-name }} \
            ${{ needs.prepare.outputs.context-args }} \
            ${{ inputs.extra-arguments }}  \
            --require-approval never \
            --outputs-file stack-outputs.json \
            $verbose
          
          # Extract stack outputs
          if [ -f "stack-outputs.json" ]; then
            # Compact JSON to single line to avoid multiline output issues
            outputs=$(jq -c '.' stack-outputs.json)
            echo "stack-outputs=$outputs" >> $GITHUB_OUTPUT
          else
            echo "stack-outputs={}" >> $GITHUB_OUTPUT
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Stack deployed successfully"

      - name: Upload deployment artifacts
        if: steps.deployment.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-outputs-${{ needs.prepare.outputs.sanitised-cdk-stack-name }}
          path: stack-outputs.json
          retention-days: 30

  # Post-deployment validation and drift detection
  validate:
    name: üîç Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [setup-node, prepare, deploy]
    if: needs.deploy.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup-node.outputs.node-version }}
          cache: ${{ needs.setup-node.outputs.package-manager == 'yarn-berry' && 'yarn' || (needs.setup-node.outputs.package-manager == 'yarn-classic' && 'yarn' || needs.setup-node.outputs.package-manager) }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ inputs.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ secrets.cfn-execution-role }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies with ${{ needs.setup-node.outputs.package-manager }}..."
          
          case "${{ needs.setup-node.outputs.package-manager }}" in
            "npm")
              npm ci
              ;;
            "yarn-classic")
              yarn install --frozen-lockfile
              ;;
            "yarn-berry")
              yarn install --immutable
              ;;
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
          esac

      - name: Validate stack deployment
        run: |
          echo "üîç Validating deployed stack..."
          
          # Check stack status
          stack_status=$(aws cloudformation describe-stacks \
            --stack-name ${{ inputs.cdk-stack-name }} \
            --query 'Stacks[0].StackStatus' \
            --output text)
          
          echo "Stack status: $stack_status"
          
          if [[ "$stack_status" =~ ^(CREATE_COMPLETE|UPDATE_COMPLETE)$ ]]; then
            echo "‚úÖ Stack deployment validated successfully"
          else
            echo "‚ùå Stack is in unexpected state: $stack_status"
            exit 1
          fi

      - name: Check for stack drift
        run: |
          echo "üîç Checking for infrastructure drift..."
          
          # Initiate drift detection
          drift_id=$(aws cloudformation detect-stack-drift \
            --stack-name ${{ inputs.cdk-stack-name }} \
            --query 'StackDriftDetectionId' \
            --output text)
          
          echo "Drift detection initiated: $drift_id"
          
          # Wait for drift detection to complete
          aws cloudformation wait stack-drift-detection-complete \
            --stack-drift-detection-id $drift_id
          
          # Get drift detection results
          drift_status=$(aws cloudformation describe-stack-drift-detection-status \
            --stack-drift-detection-id $drift_id \
            --query 'StackDriftStatus' \
            --output text)
          
          echo "Stack drift status: $drift_status"
          
          case $drift_status in
            "IN_SYNC")
              echo "‚úÖ No infrastructure drift detected"
              ;;
            "DRIFTED")
              echo "‚ö†Ô∏è Infrastructure drift detected - manual review recommended"
              ;;
            *)
              echo "‚ùì Unknown drift status: $drift_status"
              ;;
          esac

      - name: Display deployment summary
        run: |
          echo "üìã Deployment Summary"
          echo "===================="
          echo "Stack Name: ${{ inputs.cdk-stack-name }}"
          echo "Environment: ${{ inputs.environment-target }}"
          echo "Region: ${{ inputs.aws-region }}"
          echo "Status: ${{ needs.deploy.outputs.deployment-status }}"
          echo "Node Version: ${{ needs.setup-node.outputs.node-version }}"
          echo "Package Manager: ${{ needs.setup-node.outputs.package-manager }}"
          
          echo ""
          echo "üéâ Deployment completed successfully!"