name: ðŸ•µï¸ Node Pull Request Checks

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        description: "NPM authentication token for private registries"
        required: false
      ENV_VARS:
        description: "Additional environment variables as key=value pairs (one per line)"
        required: false
    inputs:
      package-manager:
        description: "Node package manager to use"
        default: yarn
        type: string
      has-env-vars:
        description: "Whether environment variables are provided"
        default: false
        type: boolean
      is-yarn-classic:
        description: "If Yarn (pre-Berry) should be used"
        default: false
        type: boolean
      build-command:
        description: "Command to override the build command"
        default: build
        type: string
      test-command:
        description: "Command to override the test command"
        default: test
        type: string
      lint-command:
        description: "Command to override the lint command"
        default: lint
        type: string
      format-command:
        description: "Command to override the format command"
        default: format
        type: string
      test-storybook-command:
        description: "Command to override the test-storybook command"
        default: test-storybook
        type: string
      check-types-command:
        description: "Command to override the check-types command"
        default: check-types
        type: string
      skip-build:
        description: "If the build step should skipped"
        default: false
        type: boolean
      skip-test:
        description: "If the test step should skipped"
        default: false
        type: boolean
      skip-lint:
        description: "If the lint step should skipped"
        default: false
        type: boolean
      skip-format:
        description: "If the format step should skipped"
        default: false
        type: boolean
      skip-test-storybook:
        description: "If the test-storybook step should skipped"
        default: false
        type: boolean
      skip-check-types:
        description: "If the check-types step should skipped"
        default: false
        type: boolean
      skip-cache:
        description: "If the cache should be skipped when installing dependencies"
        default: false
        type: boolean
      pre-install-commands:
        description: "Commands to run before dependency installation (e.g., configure registries, auth tokens)"
        default: ""
        type: string
      debug:
        description: "If debug flags should be set"
        default: false
        type: boolean
      fetch-depth:
        description: "Number of commits to fetch. 0 indicates all history for all branches and tags"
        default: 1
        type: number

jobs:
  install:
    name: ðŸ§¶ Install
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          package-manager-cache: false
          node-version-file: .nvmrc
      - name: Enable Corepack
        run: |
          # Enable corepack if packageManager is specified in package.json
          if [ -f package.json ] && jq -e '.packageManager' package.json > /dev/null 2>&1; then
            echo "packageManager field detected in package.json, enabling corepack"
            corepack enable
          fi
      - name: Configure Dependency Cache
        uses: actions/setup-node@v5
        with:
          cache: ${{ inputs.package-manager }}
          node-version-file: .nvmrc
      - name: Install safe-chain
        run: curl -fsSL https://github.com/AikidoSec/safe-chain/releases/latest/download/install-safe-chain.sh | sh -s -- --ci
      - name: Run pre-install commands
        if: inputs.pre-install-commands != ''
        run: |
          # Execute pre-install commands line by line
          echo "${{ inputs.pre-install-commands }}" | while IFS= read -r cmd; do
            if [ -n "$cmd" ]; then
              echo "Running: $cmd"
              eval "$cmd"
            fi
          done
      - name: Setup additional environment variables
        if: inputs.has-env-vars
        run: |
          # Parse and set additional environment variables securely
          while IFS= read -r line || [ -n "$line" ]; do
            if [ -n "$line" ] && [[ "$line" == *"="* ]]; then
              key="${line%%=*}"
              value="${line#*=}"
              # Mask the value in logs
              echo "::add-mask::${value}"
              echo "Setting environment variable: ${key}"
              echo "${key}=${value}" >> $GITHUB_ENV
            fi
          done <<< "${{ secrets.ENV_VARS }}"
      - name: Install dependencies
        run: |
          debug=${{ inputs.debug && '--verbose' || '' }}
          if [ "${{ inputs.package-manager }}" = "yarn" ]; then
            lock_dependencies=${{ inputs.is-yarn-classic && '--frozen-lockfile' || '--immutable' }}
            skip_cache=${{ inputs.skip-cache && '--force' || '' }}

            yarn config get nodeLinker
            yarn install $lock_dependencies $skip_cache $debug
          else
            npm ci $debug
          fi

      # Use tar to store cache so file permissions are maintained (https://github.com/actions/upload-artifact/issues/38)
      - name: Archive node_modules with tar
        run: tar -czf node_modules.tar.gz -C . node_modules/
      - uses: actions/upload-artifact@v4
        with:
          name: node_modules
          path: node_modules.tar.gz

  build:
    name: ðŸ—ï¸ Build
    needs: [install]
    if: inputs.skip-build == false
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
      - name: Fetch Origin
        run: git fetch origin
      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          package-manager-cache: false
      - name: Enable Corepack
        run: |
          # Enable corepack if packageManager is specified in package.json
          if [ -f package.json ] && jq -e '.packageManager' package.json > /dev/null 2>&1; then
            echo "packageManager field detected in package.json, enabling corepack"
            corepack enable
          fi
      - name: Configure Dependency Cache
        uses: actions/setup-node@v5
        with:
          cache: ${{ inputs.package-manager }}
      - uses: actions/download-artifact@v4
        with:
          name: node_modules
      - name: Extract node_modules with tar
        run: tar -xvzf node_modules.tar.gz -C .
      - name: Setup additional environment variables
        if: inputs.has-env-vars
        run: |
          # Parse and set additional environment variables securely
          while IFS= read -r line || [ -n "$line" ]; do
            if [ -n "$line" ] && [[ "$line" == *"="* ]]; then
              key="${line%%=*}"
              value="${line#*=}"
              # Mask the value in logs
              echo "::add-mask::${value}"
              echo "Setting environment variable: ${key}"
              echo "${key}=${value}" >> $GITHUB_ENV
            fi
          done <<< "${{ secrets.ENV_VARS }}"

      - name: Build
        run: ${{ inputs.package-manager }} run ${{ inputs.build-command }} ${{ inputs.debug && '--verbose' || '' }}

  test:
    name: ðŸ§ª Pull Request Checks
    needs: [install]
    if: inputs.skip-test == false && inputs.skip-lint == false && inputs.skip-format == false && inputs.skip-test-storybook == false && inputs.skip-check-types == false
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
      - name: Fetch Origin
        run: git fetch origin
      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          package-manager-cache: false
      - name: Enable Corepack
        run: |
          # Enable corepack if packageManager is specified in package.json
          if [ -f package.json ] && jq -e '.packageManager' package.json > /dev/null 2>&1; then
            echo "packageManager field detected in package.json, enabling corepack"
            corepack enable
          fi
      - name: Configure Dependency Cache
        uses: actions/setup-node@v5
        with:
          cache: ${{ inputs.package-manager }}
      - uses: actions/download-artifact@v4
        with:
          name: node_modules
      - name: Extract node_modules with tar
        run: tar -xvzf node_modules.tar.gz -C .
      - name: Setup additional environment variables
        if: inputs.has-env-vars
        run: |
          # Parse and set additional environment variables securely
          while IFS= read -r line || [ -n "$line" ]; do
            if [ -n "$line" ] && [[ "$line" == *"="* ]]; then
              key="${line%%=*}"
              value="${line#*=}"
              # Mask the value in logs
              echo "::add-mask::${value}"
              echo "Setting environment variable: ${key}"
              echo "${key}=${value}" >> $GITHUB_ENV
            fi
          done <<< "${{ secrets.ENV_VARS }}"

      - name: Test
        run: ${{ inputs.package-manager }} run ${{ inputs.test-command }} ${{ inputs.debug && '--verbose' || '' }}

      - name: Lint
        run: ${{ inputs.package-manager }} run ${{ inputs.lint-command }} ${{ inputs.debug && '--verbose' || '' }}

      - name: Format
        run: ${{ inputs.package-manager }} run ${{ inputs.format-command }} ${{ inputs.debug && '--verbose' || '' }}

      - name: Test Storybook
        run: ${{ inputs.package-manager }} run ${{ inputs.test-storybook-command }} ${{ inputs.debug && '--verbose' || '' }}

      - name: Check Types
        run: ${{ inputs.package-manager }} run ${{ inputs.check-types-command }} ${{ inputs.debug && '--verbose' || '' }}

  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [install, build, test]
    if: always() # Run this step regardless of success of other steps
    permissions:
      actions: write
    steps:
      - name: Delete 'node_modules' artifact from this run
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.GITHUB_RUN_ID,
            });

            const artifact = artifacts.data.artifacts.find(a => a.name === 'node_modules');

            if (!artifact) {
              core.info("No 'node_modules' artifact found for this run.");
            } else {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              core.info(`Deleted artifact 'node_modules' with ID ${artifact.id}`);
            }
